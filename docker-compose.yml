# Base Docker Compose - Core infrastructure
# Use with overlay files for embedding provider configuration:
#   docker compose -f docker-compose.yml -f docker-compose.local.yml up -d
#
# Overlay files:
#   docker-compose.local.yml      - Ollama in Docker (Linux/Windows)
#   docker-compose.ollama-host.yml - Ollama on host (Mac GPU)
#   docker-compose.openai.yml     - OpenAI API

services:
  # Vector Database (Qdrant)
  vectordb:
    image: qdrant/qdrant:v1.12.1
    container_name: stache-vectordb
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - ${DATA_DIR:-./data}/qdrant:/qdrant/storage
    environment:
      - QDRANT__STORAGE__PERFORMANCE__MAX_OPTIMIZATION_THREADS=2
      - QDRANT__STORAGE__ON_DISK_PAYLOAD=true
      - QDRANT__STORAGE__OPTIMIZERS__MEMMAP_THRESHOLD_KB=10000
      - QDRANT__STORAGE__OPTIMIZERS__INDEXING_THRESHOLD_KB=10000
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 512M
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # MongoDB (namespace and document index)
  mongodb:
    image: mongo:7
    container_name: stache-mongodb
    ports:
      - "27017:27017"
    volumes:
      - ${DATA_DIR:-./data}/mongodb:/data/db
    environment:
      - MONGO_INITDB_DATABASE=stache
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Application (FastAPI backend + Vue frontend)
  # Pulls pre-built image by default. To build locally, add --build flag
  app:
    image: ghcr.io/stache-ai/stache:latest
    build:
      context: .
      dockerfile: ${DOCKERFILE:-Dockerfile}
      args:
        - INSTALL_PROFILE=${INSTALL_PROFILE:-full}
        - WITH_OCR=${WITH_OCR:-true}
        - WITH_DOCUMENTS=${WITH_DOCUMENTS:-true}
        - STACHE_VERSION=${STACHE_VERSION:-0.1.2}
    container_name: stache-app
    ports:
      - "8000:8000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # Provider selection (override in overlay files)
      - LLM_PROVIDER=${LLM_PROVIDER:-none}
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-}
      - VECTORDB_PROVIDER=${VECTORDB_PROVIDER:-qdrant}
      # Vector DB
      - QDRANT_URL=http://vectordb:6333
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-stache}
      # MongoDB
      - NAMESPACE_PROVIDER=mongodb
      - MONGODB_URI=mongodb://mongodb:27017
      - MONGODB_DATABASE=stache
      # App settings
      - CHUNK_SIZE=${CHUNK_SIZE:-2000}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
      - DEFAULT_CHUNKING_STRATEGY=${DEFAULT_CHUNKING_STRATEGY:-recursive}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - ENABLE_DOCUMENT_INDEX=${ENABLE_DOCUMENT_INDEX:-false}
    volumes:
      - ${DATA_DIR:-./data}/uploads:/app/uploads
      - ${DATA_DIR:-./data}:/app/data
    depends_on:
      vectordb:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
