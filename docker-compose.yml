services:
  # Vector Database (Qdrant)
  vectordb:
    image: qdrant/qdrant:v1.12.1
    container_name: stache-vectordb
    ports:
      - "6333:6333"
      - "6334:6334"  # gRPC port
    volumes:
      - ${DATA_DIR:-./data}/qdrant:/qdrant/storage
    environment:
      # Memory optimization settings
      - QDRANT__STORAGE__PERFORMANCE__MAX_OPTIMIZATION_THREADS=2
      - QDRANT__STORAGE__ON_DISK_PAYLOAD=true
      - QDRANT__STORAGE__OPTIMIZERS__MEMMAP_THRESHOLD_KB=10000
      - QDRANT__STORAGE__OPTIMIZERS__INDEXING_THRESHOLD_KB=10000
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 512M
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # MongoDB (for namespace and document index providers - enable via NAMESPACE_PROVIDER=mongodb or DOCUMENT_INDEX_PROVIDER=mongodb)
  mongodb:
    image: mongo:7
    container_name: stache-mongodb
    ports:
      - "27017:27017"
    volumes:
      - ${DATA_DIR:-./data}/mongodb:/data/db
    environment:
      - MONGO_INITDB_DATABASE=stache
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Application (FastAPI backend + Vue frontend)
  # Build options:
  #   docker compose build                    # From PyPI (default)
  #   docker compose build --build-arg DOCKERFILE=Dockerfile.dev  # From source
  #   DOCKERFILE=Dockerfile.dev docker compose build              # From source (env var)
  app:
    build:
      context: .
      dockerfile: ${DOCKERFILE:-Dockerfile}
      args:
        - INSTALL_PROFILE=${INSTALL_PROFILE:-full}
        - WITH_OCR=${WITH_OCR:-true}
        - STACHE_VERSION=${STACHE_VERSION:-0.1.0}
    container_name: stache-app
    ports:
      - "8000:8000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      # API Keys
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - COHERE_API_KEY=${COHERE_API_KEY:-}
      - MIXEDBREAD_API_KEY=${MIXEDBREAD_API_KEY:-}
      # Providers (defaults)
      - LLM_PROVIDER=${LLM_PROVIDER:-fallback}
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-openai}
      - VECTORDB_PROVIDER=${VECTORDB_PROVIDER:-qdrant}
      # Namespace provider (sqlite or mongodb)
      - NAMESPACE_PROVIDER=${NAMESPACE_PROVIDER:-sqlite}
      # MongoDB configuration
      - MONGODB_URI=${MONGODB_URI:-mongodb://mongodb:27017}
      - MONGODB_DATABASE=${MONGODB_DATABASE:-stache}
      - MONGODB_NAMESPACE_COLLECTION=${MONGODB_NAMESPACE_COLLECTION:-namespaces}
      - MONGODB_DOCUMENTS_COLLECTION=${MONGODB_DOCUMENTS_COLLECTION:-documents}
      # Document index provider (disabled, dynamodb, or mongodb)
      - DOCUMENT_INDEX_PROVIDER=${DOCUMENT_INDEX_PROVIDER:-dynamodb}
      # Ollama (running on host)
      - OLLAMA_URL=${OLLAMA_URL:-http://host.docker.internal:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.2}
      - OLLAMA_EMBEDDING_MODEL=${OLLAMA_EMBEDDING_MODEL:-mxbai-embed-large}
      # Ollama Robustness Configuration
      - OLLAMA_EMBEDDING_TIMEOUT=${OLLAMA_EMBEDDING_TIMEOUT:-90}
      - OLLAMA_LLM_TIMEOUT=${OLLAMA_LLM_TIMEOUT:-120}
      - OLLAMA_HEALTH_CHECK_TIMEOUT=${OLLAMA_HEALTH_CHECK_TIMEOUT:-5}
      - OLLAMA_MAX_RETRIES=${OLLAMA_MAX_RETRIES:-3}
      - OLLAMA_RETRY_BASE_DELAY=${OLLAMA_RETRY_BASE_DELAY:-1.0}
      - OLLAMA_RETRY_MAX_DELAY=${OLLAMA_RETRY_MAX_DELAY:-10.0}
      - OLLAMA_ENABLE_PARALLEL=${OLLAMA_ENABLE_PARALLEL:-true}
      - OLLAMA_BATCH_SIZE=${OLLAMA_BATCH_SIZE:-4}
      - OLLAMA_CIRCUIT_BREAKER_THRESHOLD=${OLLAMA_CIRCUIT_BREAKER_THRESHOLD:-15}
      - OLLAMA_CIRCUIT_BREAKER_TIMEOUT=${OLLAMA_CIRCUIT_BREAKER_TIMEOUT:-60}
      - OLLAMA_CIRCUIT_BREAKER_HALF_OPEN_MAX_CALLS=${OLLAMA_CIRCUIT_BREAKER_HALF_OPEN_MAX_CALLS:-3}
      - OLLAMA_MAX_CONNECTIONS=${OLLAMA_MAX_CONNECTIONS:-50}
      - OLLAMA_MAX_KEEPALIVE_CONNECTIONS=${OLLAMA_MAX_KEEPALIVE_CONNECTIONS:-20}
      - OLLAMA_KEEPALIVE_EXPIRY=${OLLAMA_KEEPALIVE_EXPIRY:-30}
      # LLM Fallback provider configuration
      - FALLBACK_PRIMARY=${FALLBACK_PRIMARY:-ollama}
      - FALLBACK_SECONDARY=${FALLBACK_SECONDARY:-anthropic}
      # Embedding Fallback configuration (ollama -> mixedbread for same 1024 dimensions)
      - EMBEDDING_FALLBACK_PRIMARY=${EMBEDDING_FALLBACK_PRIMARY:-ollama}
      - EMBEDDING_FALLBACK_SECONDARY=${EMBEDDING_FALLBACK_SECONDARY:-mixedbread}
      - MIXEDBREAD_MODEL=${MIXEDBREAD_MODEL:-mxbai-embed-large-v1}
      # Mixedbread Resilience Configuration
      - MIXEDBREAD_TIMEOUT=${MIXEDBREAD_TIMEOUT:-60}
      - MIXEDBREAD_MAX_RETRIES=${MIXEDBREAD_MAX_RETRIES:-3}
      - MIXEDBREAD_RETRY_BASE_DELAY=${MIXEDBREAD_RETRY_BASE_DELAY:-1.0}
      - MIXEDBREAD_RETRY_MAX_DELAY=${MIXEDBREAD_RETRY_MAX_DELAY:-10.0}
      - MIXEDBREAD_CIRCUIT_BREAKER_THRESHOLD=${MIXEDBREAD_CIRCUIT_BREAKER_THRESHOLD:-10}
      - MIXEDBREAD_CIRCUIT_BREAKER_TIMEOUT=${MIXEDBREAD_CIRCUIT_BREAKER_TIMEOUT:-60}
      - MIXEDBREAD_CIRCUIT_BREAKER_HALF_OPEN_MAX_CALLS=${MIXEDBREAD_CIRCUIT_BREAKER_HALF_OPEN_MAX_CALLS:-3}
      - MIXEDBREAD_MAX_CONNECTIONS=${MIXEDBREAD_MAX_CONNECTIONS:-50}
      - MIXEDBREAD_MAX_KEEPALIVE_CONNECTIONS=${MIXEDBREAD_MAX_KEEPALIVE_CONNECTIONS:-20}
      - MIXEDBREAD_KEEPALIVE_EXPIRY=${MIXEDBREAD_KEEPALIVE_EXPIRY:-30}
      # Embedding dimension (1024 for Ollama mxbai-embed-large, 1536 for OpenAI)
      - EMBEDDING_DIMENSION=${EMBEDDING_DIMENSION:-1024}
      # Vector DB
      - QDRANT_URL=${QDRANT_URL:-http://vectordb:6333}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-stache}
      # App settings
      - CHUNK_SIZE=${CHUNK_SIZE:-2000}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
      - DEFAULT_CHUNKING_STRATEGY=${DEFAULT_CHUNKING_STRATEGY:-recursive}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      # Document index (disabled by default for local, uses DynamoDB in AWS)
      - ENABLE_DOCUMENT_INDEX=${ENABLE_DOCUMENT_INDEX:-false}
    volumes:
      - ${DATA_DIR:-./data}/uploads:/app/uploads
      - ${DATA_DIR:-./data}:/app/data  # Namespace DB and other app data
    depends_on:
      vectordb:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  qdrant_data:
